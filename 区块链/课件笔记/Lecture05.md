# Lecture 05 Bitcoin挖矿与分叉的原理与机制

> 区块链发布：一个矿工获得记账权的时候，他有权向整个网络广播他所打包生成的区块，别的节点收到这个新的区块后，验证合法性后就要添加到区块链的尾部了
>
> > 物理算力（机器算力的累计）、逻辑算力和有效算力？
> >
> > 矿工根据某种表示分到不同分片zone
> >
> > 分片的有效算力不仅考虑该片内矿工的算力，还有考虑到其他片的矿工也会在这个区域挖矿的情况
> >
> > 物理算力 单分片， 逻辑算力 考虑其他矿工在这个片的挖矿

## Part 01 挖矿的数学基础

* 挖矿的概率分布：

  * 发现下一个区块所需的时间的概率密度函数满足**指数分布**，泊松过程，无记忆性

    > 指数分布复习：$X \sim E(\lambda)$，描述泊松过程中事件之间的时间的概率分布，即事件以恒定速率连续且独立地发生的过程
    >
    > 泊松过程：一种累计随机过程发生次数的最基本的独立增量过程
    >
    > 概率密度函数：$f(x) = \lambda e^{-\lambda x}$($x > 0$), else = 0
    >
    > 无记忆性：$s, t \ge 0 \Rightarrow P(T > s + t | T >t) = P(T > s)$ 

* 挖矿难度
  * 困难在于衡量挖矿一个比特币区块的难度，即寻找给定目标以下的哈希值的难度。
  * 高难度意味着挖掘相同数量的区块需要更多的计算能力，从而使网络更安全，不受攻击。
  * 难度的调整直接与总哈希率(TH/s)图中估计的总挖掘功率有关。
  * 调整采矿难度：每2016个区块(大约每2周)调整一次难度，使**每个区块之间的平均时间保持10分钟**。
    * 下一难度 = 之前的难度 * 2周 / 最近2016块的挖掘时间

## Part 02 分叉 Forking

* 比特币网络使用最长链机制来解决分叉问题。 

* 软分叉：发生在打补丁加入新特性，现有的规则更加严格的时候，使得结点保持原状，新节点进行更新。
  * 旧节点能接受的东西新结点不一定能接受
  * **当新共识规则发布后，没有升级的节点会因为不知道新共识规则下，而生产不合法的区块，就会产生临时性分叉**。
    * **此时：老节点挖到无效块，这些块不会被新节点接收，强迫老节点更新协议、规则，转而扩展最长的链 ，分叉自动消失**
* 硬分叉：发生在规则发生改变的时候，产生了一个不同的链，而新旧节点互不兼容。
  * 新节点能接受的东西旧结点不一定能接受
  * **区块链发生永久性分歧，在新共识规则发布后，部分没有升级的节点无法验证已经升级的节点生产的区块，通常硬分叉就会发生。** 
* 恶意的分叉：（最长链机制带来的副作用） 为了双花，利用分叉发动51%攻击。

## Part 03 比特币安全机制的保障

* 恶意节点可以伪造一个交易把别人的钱转给自己吗
  * 不能，因为有签名机制，别的 honest 节点不会承认该交易；即使该交易已上链，也可以通过分叉把它废除了，这样该恶意节点白费力气又损失了钱  
* 恶意节点可以双花吗？
  * 很难，除非有51%算力 

* 如果大部分算力是诚实的，可以避免自私挖矿
  * 自私挖矿：悄悄挖不发布，为了获取更多的出块奖励  
    * 一旦发布出去，大家都会在新区块后边平等地开始竞争  
    * 如果挖矿者先藏起来，然后自己继续往后挖，就可能可以获取很多收益。但它存在风险，不发布的块有可能会浪费掉（被别人挖到），所以还不如赶紧发布出去获取当前的出块奖励
    * 自私挖矿的收益曲线：如果一个矿工他的算力超过全网的三分一，他很可能为了更多的收益而选择自私挖矿  

